<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Period Selector</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-2xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">Debug Period Selector</h1>

        <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
            <h2 class="text-xl font-semibold mb-4">Period Selector Test</h2>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Period</label>
                <select id="period-selector" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                    <option value="">Loading periods...</option>
                </select>
            </div>

            <button id="test-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                Test Update Selector
            </button>

            <div class="mt-4">
                <h3 class="font-semibold">Console Output:</h3>
                <div id="console-output" class="bg-gray-100 p-3 mt-2 rounded text-sm font-mono max-h-64 overflow-auto"></div>
            </div>
        </div>
    </div>

    <script>
        // Console capture for debugging
        const originalLog = console.log;
        const originalError = console.error;
        const outputDiv = document.getElementById('console-output');

        function addToOutput(message, type = 'log') {
            const div = document.createElement('div');
            div.className = type === 'error' ? 'text-red-600' : 'text-gray-800';
            div.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            outputDiv.appendChild(div);
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addToOutput(args.join(' '), 'log');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addToOutput('ERROR: ' + args.join(' '), 'error');
        };

        // Mock period data
        const testPeriods = [
            {id: 1, name: "January 2024", start_date: "2024-01-01", end_date: "2024-01-31", status: "Completed"},
            {id: 2, name: "February 2024", start_date: "2024-02-01", end_date: "2024-02-29", status: "Completed"},
            {id: 3, name: "March 2024", start_date: "2024-03-01", end_date: "2024-03-31", status: "Completed"},
            {id: 7, name: "test", start_date: "2025-09-15", end_date: "2025-10-16", status: "Processing"}
        ];

        function updatePeriodSelector(periods, currentPeriod = null) {
            try {
                console.log('updatePeriodSelector called with periods:', periods);

                const selector = document.getElementById('period-selector');
                console.log('Found selector:', selector);

                if (!selector) {
                    console.error('period-selector not found!');
                    return;
                }

                console.log('Current selector innerHTML before clear:', selector.innerHTML);
                selector.innerHTML = '';
                console.log('Selector cleared successfully');

                if (!periods || periods.length === 0) {
                    console.log('No periods available');
                    selector.innerHTML = '<option value="">No periods available</option>';
                    return;
                }

                console.log('About to process periods, count:', periods.length);

                periods.forEach((period, index) => {
                    console.log(`Processing period ${index}:`, period);

                    const option = document.createElement('option');
                    option.value = period.id;
                    option.textContent = period.name;

                    if (currentPeriod && period.id == currentPeriod.id) {
                        option.selected = true;
                        console.log('Selected period:', period.name);
                    }

                    selector.appendChild(option);
                    console.log(`Added option ${index}: ${period.name}`);
                });

                console.log('Final selector innerHTML:', selector.innerHTML);
                console.log('Selector children count:', selector.children.length);

                return true;
            } catch (error) {
                console.error('Error in updatePeriodSelector:', error);
                console.error('Error stack:', error.stack);
                return false;
            }
        }

        // Test button handler
        document.getElementById('test-btn').addEventListener('click', function() {
            console.log('=== STARTING PERIOD SELECTOR TEST ===');
            updatePeriodSelector(testPeriods, testPeriods[3]);
            console.log('=== TEST COMPLETED ===');
        });

        // Auto-run test on load
        window.addEventListener('load', function() {
            console.log('Page loaded, running auto test...');
            setTimeout(() => {
                updatePeriodSelector(testPeriods, testPeriods[3]);
            }, 1000);
        });
    </script>
</body>
</html>